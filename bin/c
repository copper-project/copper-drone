#/bin/bash
mkdir -p remote/usr/lib
mkdir -p remote/usr/include
if [ ! -L remote/lib ]; then
    ln -s usr/lib remote/lib
fi

rsync -avz --delete copper8:/usr/lib remote/usr
rsync -avz --delete copper8:/usr/include remote/usr

export LIBRARY_PATH=$(pwd)/remote/usr/lib/aarch64-linux-gnu:$LIBRARY_PATH
export LD_LIBRARY_PATH=$(pwd)/remote/usr/lib/aarch64-linux-gnu:$LD_LIBRARY_PATH

# Explicitly force ld to search the correct locations
export LDFLAGS="-L$(pwd)/remote/usr/lib/aarch64-linux-gnu -L$(pwd)/remote/lib/aarch64-linux-gnu -Wl,-rpath-link,$(pwd)/remote/usr/lib/aarch64-linux-gnu"

RUSTFLAGS="-L $(pwd)/remote/usr/lib/aarch64-linux-gnu \
  -C link-arg=-dynamic-linker \
  -C link-arg=$(pwd)/remote/usr/lib/aarch64-linux-gnu/ld-linux-aarch64.so.1 \
  -C link-arg=-Wl,-rpath,$(pwd)/remote/usr/lib/aarch64-linux-gnu \
  -C link-arg=-Wl,-rpath-link,$(pwd)/remote/usr/lib/aarch64-linux-gnu" \
PKG_CONFIG_PATH=$(pwd)/remote/usr/lib/pkgconfig \
PKG_CONFIG_SYSROOT_DIR=$(pwd)/remote \
LDFLAGS="$LDFLAGS" \
cargo build --target aarch64-unknown-linux-gnu


scp target/aarch64-unknown-linux-gnu/debug/drone copper8:

